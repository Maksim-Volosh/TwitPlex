{% extends "base.html" %}
{% load static %}
{% load tweet_tags %}

{% block title %}Home - TwitPlex{% endblock title %}Home - TwitPlex


{% block body %}
<section data-bs-version="5.1" class="b">

</section>
{% for tw in tweets %}
<section data-bs-version="5.1" class="article07 cid-u9LgirLGy7" id="article20-i">
  <div class="container">
    <div class="row justify-content-center">
      <div class="card col-md-12 col-lg-7">
        <div class="card-wrapper twit">
          <div class="col-12 content-head d-flex flex-column">
            <div class="twit-first d-flex flex-row">
              <div class="img-a">
                {% if tw.owner.image %}
                <a href="{{ tw.owner.image.url }}"><img src="{{ tw.owner.image.url }}" alt="avatar" class="twit-avatar"></a>
                {% else %}
                <img src="{% static "img/no_avatar.jpg" %}" alt="avatar" class="twit-avatar">
                {% endif %}
              </div>
          
              <div class="cont-title">
                <h3 class="mbr-section-title mbr-fonts-style align-left mb-0 display-2 d-flex align-items-center tw-t">
                  <strong class=""> {{ tw.owner.name|capfirst }} </strong><span class="gray">@{{ tw.owner|capfirst }} ·
                      {% if tw.time_create.year == current_year %}
                          {{ tw.time_create|date:"M d" }}
                      {% else %}
                          {{ tw.time_create|date:"M d, Y" }}
                      {% endif %}
                  </span>
                </h3>
              </div>
            </div>
            <div class="twit-second">
              <div class="counter-container mbr-text mbr-fonts-style display-7 tw-tx">
                <p>{{ tw.tweet|linebreaks }}</p>
                  
              </div>
            </div>
          </div>
          <div class="align-left twit-react">
            <div class="svg-i">
              {% if request.user.is_authenticated %}
                <button class="like-btn" data-tweet-id="{{ tw.id }}">
                  <i class="fi {% check_liked_tweets tw.id request.user %}"></i>
                </button>
              {% else %}
              <a href="{% url "admin:index" %}">
                <button class="like-btn">
                  <i class="fi fi-rs-heart"></i>
                </button>
              </a>
              {% endif %}
              <span class="react-t">{{ tw.likes_count }}</span>
            </div>
            <div class="svg-i"><i class="fi fi-rs-comment-dots"></i><span class="react-t">6,3K</span></div>
            <div class="svg-i d-flex"><i class="fi fi-rr-undo"></i><span class="react-t">953</span></div>
            <div class="svg-i d-flex"><i class="fi fi-rr-bookmark cur-pos"></i><span class="react-t">1,3K</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endfor %}
    

 <div id="scrollToTop" class="scrollToTop mbr-arrow-up"><a style="text-align: center;"><i class="mbr-arrow-up-icon mbr-arrow-up-icon-cm cm-icon cm-icon-smallarrow-up"></i></a></div>
    <input name="animation" type="hidden">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% if request.user.is_authenticated %}
<script>
  $(document).ready(function(){
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    $('.like-btn').click(function(){
        var tweet_id = $(this).data('tweet-id');
        var like_btn = $(this);
        var csrftoken = getCookie('csrftoken');
        var like_icon = like_btn.find('i');
        $.ajax({
            url: '/like_tweet/',
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            data: {'tweet_id': tweet_id},
            success: function(data){
                console.log('Success:', data); // Отладочный вывод успешного ответа в консоль
                console.log('Liked:', data.liked); // Отладочный вывод статуса лайка в консоль
                if (data.liked) {
                    like_icon.removeClass('fi-rs-heart').addClass('fi-ss-heart');
                } else {
                    like_icon.removeClass('fi-ss-heart').addClass('fi-rs-heart');
                }
                like_btn.siblings('.react-t').text(data.likes_count); // Обновляем количество лайков
            },
            error: function(xhr, status, error) {
                console.error('Error:', error); // Отладочный вывод ошибки в консоль
            }
        });
    });
});
</script>
{% endif %}

    
    
{% endblock body %}